<!DOCTYPE html>
<html lang="pt-BR">

<head>
  <meta charset="UTF-8" />
  <title>Laudos | Controle</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- Favicons e Icones -->
  <link rel="apple-touch-icon" href="https://v1.laudosonline.com.br/assets/images/apple-touch-icon.png" sizes="180x180">
  <link rel="icon" type="image/png" href="https://v1.laudosonline.com.br/assets/images/favicon.png" sizes="32x32">

  <style>
    .fade-in {
      animation: fadeInUp 0.25s ease-out;
    }

    @keyframes fadeInUp {
      from {
        opacity: 0;
        transform: translateY(4px);
      }

      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    .count {
      transition: all .3s ease;
    }
  </style>
</head>

<body class="bg-gradient-to-br from-slate-100 to-slate-200 min-h-screen flex flex-col">

  <!-- HEADER -->
  <header
    class="sticky top-0 z-50 backdrop-blur bg-slate-900/90 text-white px-6 py-4 flex justify-between items-center shadow">

    <!-- ESQUERDA -->
    <div class="flex items-center gap-4">

      <!-- MENU SANDUÃCHE -->
      <nav class="relative">
        <button id="menuBtn" class="p-2 rounded-lg hover:bg-slate-800 transition" aria-label="Abrir menu"
          aria-expanded="false" aria-controls="menuPanel">

          <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-white" fill="none" viewBox="0 0 24 24"
            stroke="currentColor" stroke-width="2">
            <path stroke-linecap="round" stroke-linejoin="round" d="M4 6h16M4 12h16M4 18h16" />
          </svg>
        </button>

        <!-- PAINEL -->
        <div id="menuPanel" class="absolute left-0 mt-3 w-72 rounded-xl bg-white text-slate-800 shadow-xl
           hidden overflow-hidden">

          <!-- HEADER DO PAINEL (opcional) -->
          <div class="px-4 py-3 border-b bg-slate-50">
            <div class="text-xs uppercase tracking-wide text-slate-500">NavegaÃ§Ã£o</div>
          </div>

          <div class="py-2 text-sm">

            <!-- LAUDOS (nÃ­vel 1) -->
            <button type="button"
              class="w-full flex items-center justify-between px-4 py-2 hover:bg-slate-100 font-semibold"
              data-acc-btn="lol">
              <span>PublicaÃ§Ã£o de Laudos</span>
              <span class="text-slate-400">â€º</span>
            </button>

            <!-- ConteÃºdo LAUDOS (nÃ­vel 2) -->
            <div class="hidden" data-acc-panel="lol">
              <a href="../laudos/index.html" class="block pl-8 pr-4 py-2 hover:bg-slate-100 text-slate-700">
                VisÃ£o Geral
              </a>
            </div>

            <!-- DFe (nÃ­vel 1) -->
            <button type="button"
              class="w-full flex items-center justify-between px-4 py-2 hover:bg-slate-100 font-semibold"
              data-acc-btn="dfe">
              <span>DFe (Documentos Fiscais)</span>
              <span class="text-slate-400">â€º</span>
            </button>

            <!-- ConteÃºdo DFe (nÃ­vel 2) -->
            <div class="hidden" data-acc-panel="dfe">

              <!-- NFe -->
              <button type="button"
                class="w-full flex items-center justify-between pl-8 pr-4 py-2 hover:bg-slate-100 text-slate-700 font-medium"
                data-acc-btn="nfe">
                <span>NFe</span>
                <span class="text-slate-400">â€º</span>
              </button>

              <div class="hidden" data-acc-panel="nfe">
                <a href="../nfe/index.html" class="block pl-12 pr-4 py-2 hover:bg-slate-100">
                  VisÃ£o Geral
                </a>
                <a href="../nfe/controle_nfe_logs.html" class="block pl-12 pr-4 py-2 hover:bg-slate-100">
                  Erros
                </a>
              </div>

              <!-- NFSe -->
              <button type="button"
                class="w-full flex items-center justify-between pl-8 pr-4 py-2 hover:bg-slate-100 text-slate-700 font-medium"
                data-acc-btn="nfse">
                <span>NFSe</span>
                <span class="text-slate-400">â€º</span>
              </button>

              <div class="hidden" data-acc-panel="nfse">
                <a href="nfse_visao_geral.html" class="block pl-12 pr-4 py-2 hover:bg-slate-100">
                  VisÃ£o Geral
                </a>
                <a href="nfse_erros.html" class="block pl-12 pr-4 py-2 hover:bg-slate-100">
                  Erros
                </a>
              </div>

            </div>

            <!-- DESENVOLVIMENTO (nÃ­vel 1) -->
            <button type="button"
              class="w-full flex items-center justify-between px-4 py-2 hover:bg-slate-100 font-semibold"
              data-acc-btn="dev">
              <span>Desenvolvimento</span>
              <span class="text-slate-400">â€º</span>
            </button>

            <!-- ConteÃºdo Desenvolvimento (nÃ­vel 2) -->
            <div class="hidden" data-acc-panel="dev">
              <a href="../desenv/gerador_pix.html" class="block pl-8 pr-4 py-2 hover:bg-slate-100 text-slate-700">
                Chave PIX
              </a>
              <a href="../desenv/leitor_pdf.html" class="block pl-8 pr-4 py-2 hover:bg-slate-100 text-slate-700">
                Leitor PDF (PDF.js)
              </a>
            </div>

          </div>
        </div>
      </nav>


      <!-- TEXTO -->
      <h1 class="text-lg font-semibold tracking-wide whitespace-nowrap">
        Vertis â€¢ Laudos â€¢ PublicaÃ§Ã£o
      </h1>
    </div>

    <!-- DIREITA -->
    <div class="flex items-center gap-4">
      <span id="refreshIndicator" class="text-xs text-slate-300 opacity-0 transition-opacity">
        Atualizando...
      </span>

      <img src="https://v1.laudosonline.com.br/assets/images/logo-primary-white.png" alt="Vertis" class="h-8" />
    </div>

  </header>



  <main class="p-6 flex-1 space-y-6">

    <!-- KPIs + Modo (Hoje/MÃªs) -->
    <section class="bg-white rounded-2xl shadow p-4">
      <div class="flex flex-col lg:flex-row lg:items-center lg:justify-between gap-3">
        <div>
          <h2 id="modeTitle" class="text-sm font-semibold text-slate-700">Hoje</h2>
          <p class="text-xs text-slate-500">VisÃ£o geral da publicaÃ§Ã£o de laudos</p>
        </div>

        <!-- Toggle (segmentado) -->
        <div class="flex items-center gap-2">
          <div class="inline-flex rounded-xl bg-slate-100 p-1 border border-slate-200">
            <button id="btnModeHoje" type="button"
              class="px-3 py-1.5 text-sm rounded-lg bg-white shadow-sm text-slate-800 font-semibold transition">
              Hoje
            </button>
            <button id="btnModeMes" type="button"
              class="px-3 py-1.5 text-sm rounded-lg text-slate-600 hover:text-slate-800 transition">
              MÃªs
            </button>
          </div>

          <span class="text-xs text-slate-500 hidden sm:inline">Tabela e KPIs alternam conforme o modo</span>
        </div>
      </div>

      <div class="mt-4 grid grid-cols-1 xl:grid-cols-2 gap-4">
        <!-- Internet -->
        <div class="rounded-2xl border border-slate-200 p-4">
          <div class="flex items-start justify-between">
            <div class="flex items-center gap-2">
              <span class="inline-flex h-2.5 w-2.5 rounded-full bg-indigo-500"></span>
              <h3 class="text-sm font-semibold text-slate-700">Internet</h3>
            </div>
            <div class="text-right">
              <p class="text-[11px] text-slate-500">Total</p>
              <p id="kpi_lol_tot" class="text-xl font-bold text-slate-800 count">0</p>
              <svg id="spark_lol" class="mt-1 h-6 w-24 text-slate-400" viewBox="0 0 100 24" preserveAspectRatio="none"
                aria-label="Sparkline Internet">
                <polyline id="spark_lol_line" fill="none" stroke="currentColor" stroke-width="2" points=""></polyline>
              </svg>
            </div>
          </div>

          <div class="mt-3 grid grid-cols-3 gap-3">
            <div class="space-y-1">
              <div class="flex items-center justify-between">
                <p class="text-[11px] text-slate-500">Sucesso</p>
                <span id="kpi_lol_suc_pct"
                  class="text-[10px] px-1.5 py-0.5 rounded-full bg-emerald-50 text-emerald-700 font-medium">0%</span>
              </div>
              <p id="kpi_lol_suc" class="text-2xl font-semibold text-emerald-600 count">0</p>
              <div class="h-1.5 bg-slate-200 rounded-full overflow-hidden">
                <div id="kpi_lol_suc_bar" class="h-full bg-emerald-500 w-0 transition-all duration-300"></div>
              </div>
            </div>

            <div class="space-y-1">
              <div class="flex items-center justify-between">
                <p class="text-[11px] text-slate-500">Fila</p>
                <span id="kpi_lol_fil_pct"
                  class="text-[10px] px-1.5 py-0.5 rounded-full bg-rose-50 text-rose-700 font-medium">0%</span>
              </div>
              <p id="kpi_lol_fil" class="text-2xl font-semibold text-rose-600 count">0</p>
              <div class="h-1.5 bg-slate-200 rounded-full overflow-hidden">
                <div id="kpi_lol_fil_bar" class="h-full bg-rose-500 w-0 transition-all duration-300"></div>
              </div>
            </div>

            <div class="space-y-1">
              <div class="flex items-center justify-between">
                <p class="text-[11px] text-slate-500">Erro</p>
                <span id="kpi_lol_err_pct"
                  class="text-[10px] px-1.5 py-0.5 rounded-full bg-amber-50 text-amber-700 font-medium">0%</span>
              </div>
              <p id="kpi_lol_err" class="text-2xl font-semibold text-amber-600 count">0</p>
              <div class="h-1.5 bg-slate-200 rounded-full overflow-hidden">
                <div id="kpi_lol_err_bar" class="h-full bg-amber-500 w-0 transition-all duration-300"></div>
              </div>
            </div>
          </div>

          <div class="mt-3 flex items-center justify-between text-[11px] text-slate-500">
            <span>Ãšltimo envio</span>
            <span class="flex items-center gap-2">
              <span id="kpi_lol_stale"
                class="hidden text-[10px] px-2 py-0.5 rounded-full bg-slate-100 text-slate-700 border border-slate-200">â€”</span>
              <span id="kpi_lol_ult" class="font-medium text-slate-700">â€”</span>
            </span>
          </div>
        </div>

        <!-- E-mail -->
        <div class="rounded-2xl border border-slate-200 p-4">
          <div class="flex items-start justify-between">
            <div class="flex items-center gap-2">
              <span class="inline-flex h-2.5 w-2.5 rounded-full bg-cyan-500"></span>
              <h3 class="text-sm font-semibold text-slate-700">E-mail</h3>
            </div>
            <div class="text-right">
              <p class="text-[11px] text-slate-500">Total</p>
              <p id="kpi_loe_tot" class="text-xl font-bold text-slate-800 count">0</p>
              <svg id="spark_loe" class="mt-1 h-6 w-24 text-slate-400" viewBox="0 0 100 24" preserveAspectRatio="none"
                aria-label="Sparkline E-mail">
                <polyline id="spark_loe_line" fill="none" stroke="currentColor" stroke-width="2" points=""></polyline>
              </svg>
            </div>
          </div>

          <div class="mt-3 grid grid-cols-3 gap-3">
            <div class="space-y-1">
              <div class="flex items-center justify-between">
                <p class="text-[11px] text-slate-500">Sucesso</p>
                <span id="kpi_loe_suc_pct"
                  class="text-[10px] px-1.5 py-0.5 rounded-full bg-emerald-50 text-emerald-700 font-medium">0%</span>
              </div>
              <p id="kpi_loe_suc" class="text-2xl font-semibold text-emerald-600 count">0</p>
              <div class="h-1.5 bg-slate-200 rounded-full overflow-hidden">
                <div id="kpi_loe_suc_bar" class="h-full bg-emerald-500 w-0 transition-all duration-300"></div>
              </div>
            </div>

            <div class="space-y-1">
              <div class="flex items-center justify-between">
                <p class="text-[11px] text-slate-500">Fila</p>
                <span id="kpi_loe_fil_pct"
                  class="text-[10px] px-1.5 py-0.5 rounded-full bg-rose-50 text-rose-700 font-medium">0%</span>
              </div>
              <p id="kpi_loe_fil" class="text-2xl font-semibold text-rose-600 count">0</p>
              <div class="h-1.5 bg-slate-200 rounded-full overflow-hidden">
                <div id="kpi_loe_fil_bar" class="h-full bg-rose-500 w-0 transition-all duration-300"></div>
              </div>
            </div>

            <div class="space-y-1">
              <div class="flex items-center justify-between">
                <p class="text-[11px] text-slate-500">Erro</p>
                <span id="kpi_loe_err_pct"
                  class="text-[10px] px-1.5 py-0.5 rounded-full bg-amber-50 text-amber-700 font-medium">0%</span>
              </div>
              <p id="kpi_loe_err" class="text-2xl font-semibold text-amber-600 count">0</p>
              <div class="h-1.5 bg-slate-200 rounded-full overflow-hidden">
                <div id="kpi_loe_err_bar" class="h-full bg-amber-500 w-0 transition-all duration-300"></div>
              </div>
            </div>
          </div>

          <div class="mt-3 flex items-center justify-between text-[11px] text-slate-500">
            <span>Ãšltimo envio</span>
            <span class="flex items-center gap-2">
              <span id="kpi_loe_stale"
                class="hidden text-[10px] px-2 py-0.5 rounded-full bg-slate-100 text-slate-700 border border-slate-200">â€”</span>
              <span id="kpi_loe_ult" class="font-medium text-slate-700">â€”</span>
            </span>
          </div>
        </div>
      </div>
    </section>
    <!-- FILTRO -->
    <div class="bg-white rounded-2xl shadow p-4 flex flex-col sm:flex-row sm:items-center gap-3 sm:gap-4">
      <input id="filterInput" type="text" placeholder="ðŸ” Filtrar por cÃ³digo ou nome da unidade..."
        class="w-full border rounded-xl px-4 py-2 focus:outline-none focus:ring" oninput="applyFilter()" />
      <div class="flex items-center gap-2">
        <span id="modeBadge"
          class="text-xs px-2 py-1 rounded-full bg-slate-100 text-slate-700 border border-slate-200">Modo: Hoje</span>
        <button id="btnOnlyErrors" type="button"
          class="text-xs px-2 py-1 rounded-full border border-slate-200 bg-white text-slate-700 hover:bg-slate-50 transition">
          ðŸ‘€ Somente erro
        </button>
        <span class="text-sm text-slate-500 whitespace-nowrap">Auto-refresh 5 min</span>
      </div>
    </div>

    <!-- TABELA -->
    <div class="bg-white rounded-2xl shadow overflow-x-auto max-h-[70vh]">
      <table class="min-w-full text-sm border-collapse">
        <thead class="bg-slate-200 sticky top-0 z-40">
          <tr id="table-head"></tr>
        </thead>
        <tbody id="table-body" class="divide-y"></tbody>
        <tfoot class="bg-slate-100 sticky bottom-0 font-semibold">
          <tr id="table-footer"></tr>
        </tfoot>
      </table>
    </div>

    <!-- PAGINAÃ‡ÃƒO -->
    <div class="flex items-center justify-between px-2 text-sm text-slate-600">
      <span id="pageInfo"></span>
      <div id="pagination" class="flex gap-1"></div>
    </div>

  </main>

  <script>
    // const endpoint = "http://177.11.209.38/vertis/VertisConnect.dll/api/V1.1/get_publicacao_controle";
    const endpoint = "/api/laudos/controle";

    const PAGE_SIZE = 10;
    let currentPage = 1;

    const isNumeric = (k) => k.startsWith('lol_') || k.startsWith('loe_');

    const columnsHoje = [
      { key: 'cod_unid_negoc', label: 'Neg', sticky: true, width: 50 },
      { key: 'cod_unid_oper', label: 'Oper', sticky: true, width: 50 },
      { key: 'nom_unid_oper', label: 'Cliente', sticky: true, width: 250 },

      { key: 'lol_hoj_fil', label: 'Internet â€¢ Fila', sum: true },
      { key: 'lol_hoj_err', label: 'Internet â€¢ Erro', sum: true },
      { key: 'lol_hoj_suc', label: 'Internet â€¢ Sucesso', sum: true },
      { key: 'dth_ult_lol', label: 'Ãšlt. Internet' },

      { key: 'loe_hoj_fil', label: 'E-mail â€¢ Fila', sum: true },
      { key: 'loe_hoj_err', label: 'E-mail â€¢ Erro', sum: true },
      { key: 'loe_hoj_suc', label: 'E-mail â€¢ Sucesso', sum: true },
      { key: 'dth_ult_loe', label: 'Ãšlt. E-mail' },

      { key: 'dth_ult_atualizacao', label: 'AtualizaÃ§Ã£o' }
    ];

    const columnsMes = [
      { key: 'cod_unid_negoc', label: 'Neg', sticky: true, width: 50 },
      { key: 'cod_unid_oper', label: 'Oper', sticky: true, width: 50 },
      { key: 'nom_unid_oper', label: 'Cliente', sticky: true, width: 250 },

      { key: 'lol_mes_fil', label: 'Internet â€¢ Fila', sum: true },
      { key: 'lol_mes_err', label: 'Internet â€¢ Erro', sum: true },
      { key: 'lol_mes_suc', label: 'Internet â€¢ Sucesso', sum: true },

      { key: 'loe_mes_fil', label: 'E-mail â€¢ Fila', sum: true },
      { key: 'loe_mes_err', label: 'E-mail â€¢ Erro', sum: true },
      { key: 'loe_mes_suc', label: 'E-mail â€¢ Sucesso', sum: true },

      { key: 'dth_ult_atualizacao', label: 'AtualizaÃ§Ã£o' }
    ];

    let viewMode = 'hoje';
    let columns = columnsHoje;

    let originalData = [], filteredData = [], sortKey = null, sortAsc = true;
    let modeBound = false;
    let onlyErrors = false;
    const HISTORY_KEY = 'laudos_pub_history_v1';
    const HISTORY_MAX = 60; // Ãºltimos pontos (auto-refresh 5 min)


    const getPagedData = () =>
      filteredData.slice((currentPage - 1) * PAGE_SIZE, currentPage * PAGE_SIZE);

    const totalPages = () =>
      Math.ceil(filteredData.length / PAGE_SIZE) || 1;

    /* ===== KPIs ===== */
    const pct = (valor, total) =>
      total > 0 ? ((valor / total) * 100).toFixed(1) + '%' : '0%';

    const setBar = (id, valor, total) => {
      const el = document.getElementById(id);
      if (!el) return;

      const pct = total > 0 ? Math.min((valor / total) * 100, 100) : 0;
      el.style.width = pct + '%';
    };

    const parseBrDateTime = (s) => {
      // "DD/MM/YYYY HH:MM:SS"
      if (!s || typeof s !== 'string') return null;
      const m = s.match(/(\d{2})\/(\d{2})\/(\d{4})\s+(\d{2}):(\d{2})(?::(\d{2}))?/);
      if (!m) return null;
      const [_, dd, mm, yyyy, HH, MI, SS] = m;
      return new Date(Number(yyyy), Number(mm) - 1, Number(dd), Number(HH), Number(MI), Number(SS || 0));
    };

    const parseIsoDateTime = (value) => {
      if (!value) return null;
      // Esperado: YYYY-MM-DD HH:mm:SS
      const [datePart, timePart] = value.split(' ');
      if (!datePart || !timePart) return null;

      const [year, month, day] = datePart.split('-').map(Number);
      const [hour, minute, second] = timePart.split(':').map(Number);

      return new Date(year, month - 1, day, hour, minute, second);
    };

    const formatDateTimeBR = (date) => {
      if (!(date instanceof Date) || isNaN(date)) return '';

      const pad = (n) => String(n).padStart(2, '0');

      const day = pad(date.getDate());
      const month = pad(date.getMonth() + 1);
      const year = date.getFullYear();

      const hour = pad(date.getHours());
      const minute = pad(date.getMinutes());
      const second = pad(date.getSeconds());

      return `${day}/${month}/${year} ${hour}:${minute}:${second}`;
    };

    const minutesSince = (dt) => {
      if (!dt) return null;
      const diffMs = Date.now() - dt.getTime();
      return Math.floor(diffMs / 60000);
    };

    const isFresh = (dt, maxMinutes = 30) => {
      const mins = minutesSince(dt);
      if (mins == null) return null;     // sem data
      if (mins < 0) return true;         // data no "futuro" (relÃ³gio/servidor), considera OK
      return mins <= maxMinutes;
    };

    const renderFreshIcon = (dt, maxMinutes = 30) => {
      const ok = isFresh(dt, maxMinutes);
      const dtBr = formatDateTimeBR(dt);

      if (ok === null) {
        return `<span class="inline-flex items-center gap-2 text-slate-400" title="Sem data">
      <span class="h-2 w-2 rounded-full bg-slate-300"></span><span class="text-xs">â€”</span>
    </span>`;
      }

      if (ok) {
        return `<span class="inline-flex items-center justify-center h-7 w-7 rounded-full bg-emerald-50 text-emerald-700 border border-emerald-200"
      title="${dtBr}">
      âœ“
    </span>`;
      }

      const mins = minutesSince(dt);
      return `<span class="inline-flex items-center justify-center h-7 w-7 rounded-full bg-rose-50 text-rose-700 border border-rose-200"
    title="${dtBr}">
    !
  </span>`;
    };


    const setStaleBadge = (badgeId, dt) => {
      const el = document.getElementById(badgeId);
      if (!el) return;

      const mins = minutesSince(dt);
      if (mins == null || mins < 0) {
        el.classList.add('hidden');
        el.textContent = 'â€”';
        return;
      }

      el.classList.remove('hidden');
      el.textContent = `sem envio hÃ¡ ${mins} min`;

      // cores por faixa
      el.classList.remove('bg-slate-100', 'text-slate-700', 'border-slate-200',
        'bg-amber-50', 'text-amber-700', 'border-amber-200',
        'bg-rose-50', 'text-rose-700', 'border-rose-200');

      if (mins >= 60) {
        el.classList.add('bg-rose-50', 'text-rose-700', 'border-rose-200');
      } else if (mins >= 20) {
        el.classList.add('bg-amber-50', 'text-amber-700', 'border-amber-200');
      } else {
        el.classList.add('bg-slate-100', 'text-slate-700', 'border-slate-200');
      }
    };

    const loadHistory = () => {
      try {
        const raw = localStorage.getItem(HISTORY_KEY);
        const arr = raw ? JSON.parse(raw) : [];
        return Array.isArray(arr) ? arr : [];
      } catch {
        return [];
      }
    };

    const saveHistory = (arr) => {
      try {
        localStorage.setItem(HISTORY_KEY, JSON.stringify(arr.slice(-HISTORY_MAX)));
      } catch { }
    };

    const updateSpark = (lineId, values) => {
      const line = document.getElementById(lineId);
      if (!line) return;

      if (!values || values.length < 2) {
        line.setAttribute('points', '');
        return;
      }

      const minV = Math.min(...values);
      const maxV = Math.max(...values);
      const span = (maxV - minV) || 1;

      const pts = values.map((v, i) => {
        const x = (i / (values.length - 1)) * 100;
        const y = 22 - ((v - minV) / span) * 20; // padding top/bottom
        return `${x.toFixed(1)},${y.toFixed(1)}`;
      }).join(' ');

      line.setAttribute('points', pts);
    };

    const updateSparklines = (point) => {
      // SÃ³ em "Hoje"
      const svgLol = document.getElementById('spark_lol');
      const svgLoe = document.getElementById('spark_loe');

      if (viewMode !== 'hoje') {
        if (svgLol) svgLol.classList.add('hidden');
        if (svgLoe) svgLoe.classList.add('hidden');
        return;
      }

      if (svgLol) svgLol.classList.remove('hidden');
      if (svgLoe) svgLoe.classList.remove('hidden');

      const hist = loadHistory();

      // Dedup simples: evita empilhar pontos em re-render (filtro/paginaÃ§Ã£o)
      const last = hist[hist.length - 1];
      const shouldPush = !last || (point.t - last.t) > 60_000;

      const next = shouldPush ? [...hist, point] : [...hist.slice(0, -1), point];
      const trimmed = next.slice(-HISTORY_MAX);
      saveHistory(trimmed);

      updateSpark('spark_lol_line', trimmed.map(p => p.lol_tot));
      updateSpark('spark_loe_line', trimmed.map(p => p.loe_tot));
    };


    function updateKPIs() {
      const sum = (k) => filteredData.reduce((t, r) => t + Number(r[k] || 0), 0);

      const prefix = viewMode === 'hoje' ? 'hoj' : 'mes';

      const lol_fil = sum(`lol_${prefix}_fil`);
      const lol_err = sum(`lol_${prefix}_err`);
      const lol_suc = sum(`lol_${prefix}_suc`);
      const lol_tot = lol_fil + lol_err + lol_suc;

      const loe_fil = sum(`loe_${prefix}_fil`);
      const loe_err = sum(`loe_${prefix}_err`);
      const loe_suc = sum(`loe_${prefix}_suc`);
      const loe_tot = loe_fil + loe_err + loe_suc;

      // Titles
      const title = viewMode === 'hoje' ? 'Hoje' : 'MÃªs';
      document.getElementById('modeTitle').textContent = title;
      document.getElementById('modeBadge').textContent = `Modo: ${title}`;

      // Internet
      document.getElementById('kpi_lol_tot').textContent = lol_tot;
      document.getElementById('kpi_lol_suc').textContent = lol_suc;
      document.getElementById('kpi_lol_fil').textContent = lol_fil;
      document.getElementById('kpi_lol_err').textContent = lol_err;

      document.getElementById('kpi_lol_suc_pct').textContent = pct(lol_suc, lol_tot);
      document.getElementById('kpi_lol_fil_pct').textContent = pct(lol_fil, lol_tot);
      document.getElementById('kpi_lol_err_pct').textContent = pct(lol_err, lol_tot);

      setBar('kpi_lol_suc_bar', lol_suc, lol_tot);
      setBar('kpi_lol_fil_bar', lol_fil, lol_tot);
      setBar('kpi_lol_err_bar', lol_err, lol_tot);

      // E-mail
      document.getElementById('kpi_loe_tot').textContent = loe_tot;
      document.getElementById('kpi_loe_suc').textContent = loe_suc;
      document.getElementById('kpi_loe_fil').textContent = loe_fil;
      document.getElementById('kpi_loe_err').textContent = loe_err;

      document.getElementById('kpi_loe_suc_pct').textContent = pct(loe_suc, loe_tot);
      document.getElementById('kpi_loe_fil_pct').textContent = pct(loe_fil, loe_tot);
      document.getElementById('kpi_loe_err_pct').textContent = pct(loe_err, loe_tot);

      setBar('kpi_loe_suc_bar', loe_suc, loe_tot);
      setBar('kpi_loe_fil_bar', loe_fil, loe_tot);
      setBar('kpi_loe_err_bar', loe_err, loe_tot);

      // Ãšltimos (usado tambÃ©m para badge "sem envio hÃ¡ X min")
      const lastLol = filteredData.map(r => r.dth_ult_lol).filter(Boolean).sort().slice(-1)[0] || 'â€”';
      const lastLoe = filteredData.map(r => r.dth_ult_loe).filter(Boolean).sort().slice(-1)[0] || 'â€”';

      document.getElementById('kpi_lol_ult').textContent = lastLol;
      document.getElementById('kpi_loe_ult').textContent = lastLoe;

      // Badge "sem envio hÃ¡ X min" (baseado nos Ãºltimos envios)
      setStaleBadge('kpi_lol_stale', parseIsoDateTime(lastLol));
      setStaleBadge('kpi_loe_stale', parseIsoDateTime(lastLoe));

      // Highlight automÃ¡tico quando houver erro
      const internetCard = document.getElementById('kpi_lol_err')?.closest('.rounded-2xl');
      const emailCard = document.getElementById('kpi_loe_err')?.closest('.rounded-2xl');

      const toggleErrCard = (el, hasErr) => {
        if (!el) return;
        el.classList.toggle('ring-2', hasErr);
        el.classList.toggle('ring-rose-200', hasErr);
        el.classList.toggle('bg-rose-50/40', hasErr);
      };

      toggleErrCard(internetCard, lol_err > 0);
      toggleErrCard(emailCard, loe_err > 0);

      // Sparklines (somente no modo HOJE)
      updateSparklines({
        t: Date.now(),
        lol_tot,
        loe_tot,
      });
    }

    /* ===== TABLE ===== */
    function createHeader() {
      const tr = document.getElementById('table-head');
      tr.innerHTML = '';
      let left = 0;

      columns.forEach(col => {
        const th = document.createElement('th');
        let cls = 'px-3 py-2 whitespace-nowrap cursor-pointer';
        if (isNumeric(col.key)) cls += ' text-center';

        if (col.sticky) {
          cls += ' sticky bg-slate-200 z-50';
          th.style.left = left + 'px';
          th.style.width = col.width + 'px';
          left += col.width;
        }

        th.className = cls;
        th.textContent = col.label;
        th.onclick = () => sortBy(col.key);
        tr.appendChild(th);
      });
    }

    function renderTable() {
      const tbody = document.getElementById('table-body');
      tbody.innerHTML = '';

      getPagedData().forEach((row, i) => {
        const tr = document.createElement('tr');
        const errKeys = viewMode === 'hoje' ? ['lol_hoj_err', 'loe_hoj_err'] : ['lol_mes_err', 'loe_mes_err'];
        const rowHasErr = errKeys.some(k => Number(row[k] || 0) > 0);
        tr.className = `${i % 2 ? 'bg-slate-50' : 'bg-white'} hover:bg-slate-100 fade-in` + (rowHasErr ? ' border-l-4 border-rose-400' : '');
        let left = 0;

        columns.forEach(col => {
          const td = document.createElement('td');
          let cls = 'px-3 py-2 whitespace-nowrap';

          if (isNumeric(col.key)) cls += ' text-center font-medium';

          if (col.sticky) {
            cls += ' sticky z-40 ' + (i % 2 ? 'bg-slate-50' : 'bg-white');
            td.style.left = left + 'px';
            td.style.width = col.width + 'px';
            left += col.width;
          }

          td.className = cls;
          if (col.key === 'dth_ult_atualizacao') {
            const dt = parseIsoDateTime(row[col.key]);
            const dtstr = (row[col.key]);
            td.innerHTML = `<div class="flex items-center justify-center">
            ${renderFreshIcon(dt, 30)}
            </div>`;
            td.classList.add('text-center');
          } else {
            td.textContent = row[col.key] ?? '';
          }

          const v = Number(row[col.key] || 0);
          if (col.key.includes('_err') && v > 0) {
            td.classList.add('bg-rose-50', 'text-rose-700', 'font-semibold');
          }
          tr.appendChild(td);
        });
        tbody.appendChild(tr);
      });

      renderFooter();
      updateKPIs();
      renderPagination();
    }

    function renderFooter() {
      const tr = document.getElementById('table-footer');
      tr.innerHTML = '';
      let left = 0;

      columns.forEach((col, i) => {
        const td = document.createElement('td');
        let cls = 'px-3 py-2';
        if (isNumeric(col.key)) cls += ' text-center';

        if (col.sticky) {
          cls += ' sticky bg-slate-100 z-40';
          td.style.left = left + 'px';
          td.style.width = col.width + 'px';
          left += col.width;
        }

        td.className = cls;
        td.textContent = i === 0
          ? 'Totais'
          : col.sum
            ? filteredData.reduce((t, r) => t + Number(r[col.key] || 0), 0)
            : '';
        tr.appendChild(td);
      });
    }

    function renderPagination() {
      const total = totalPages();
      const delta = 1; // quantas pÃ¡ginas antes/depois da atual
      const pages = [];
      const range = [];

      pageInfo.textContent =
        `PÃ¡gina ${currentPage} de ${total} â€¢ ${filteredData.length} registros`;

      // Sempre inclui primeira e Ãºltima
      range.push(1);
      if (total > 1) range.push(total);

      // PÃ¡ginas ao redor da atual
      for (let i = currentPage - delta; i <= currentPage + delta; i++) {
        if (i > 1 && i < total) range.push(i);
      }

      // Ordena e remove duplicados
      [...new Set(range)].sort((a, b) => a - b).forEach(p => pages.push(p));

      pagination.innerHTML = '';

      let last = 0;
      pages.forEach(p => {
        if (p - last > 1) {
          const dots = document.createElement('span');
          dots.textContent = 'â€¦';
          dots.className = 'px-2 text-slate-400';
          pagination.appendChild(dots);
        }

        const btn = document.createElement('button');
        btn.textContent = p;
        btn.className =
          `px-2 py-1 rounded ${p === currentPage
            ? 'bg-slate-700 text-white'
            : 'bg-slate-200 hover:bg-slate-300'
          }`;

        btn.onclick = () => {
          currentPage = p;
          renderTable();
        };

        pagination.appendChild(btn);
        last = p;
      });
    }


    function sortBy(key) {
      sortAsc = sortKey === key ? !sortAsc : true;
      sortKey = key;
      currentPage = 1;

      filteredData.sort((a, b) => {
        const n1 = Number(a[key]), n2 = Number(b[key]);
        if (!isNaN(n1) && !isNaN(n2)) return sortAsc ? n1 - n2 : n2 - n1;
        return sortAsc
          ? String(a[key]).localeCompare(String(b[key]))
          : String(b[key]).localeCompare(String(a[key]));
      });

      renderTable();
    }

    function applyFilter() {
      const v = filterInput.value.toLowerCase();

      const base = originalData.filter(r =>
        String(r.cod_unid_negoc).includes(v) ||
        String(r.cod_unid_oper).includes(v) ||
        String(r.nom_unid_oper).toLowerCase().includes(v)
      );

      if (!onlyErrors) {
        filteredData = base;
      } else {
        const errKeys = viewMode === 'hoje'
          ? ['lol_hoj_err', 'loe_hoj_err']
          : ['lol_mes_err', 'loe_mes_err'];

        filteredData = base.filter(r => errKeys.some(k => Number(r[k] || 0) > 0));
      }

      currentPage = 1;
      renderTable();
    }

    function setMode(mode) {
      viewMode = mode;
      columns = viewMode === 'hoje' ? columnsHoje : columnsMes;

      // Estilo dos botÃµes (segmentado)
      const btnHoje = document.getElementById('btnModeHoje');
      const btnMes = document.getElementById('btnModeMes');

      const activeCls = ['bg-white', 'shadow-sm', 'text-slate-800', 'font-semibold'];
      const inactiveCls = ['text-slate-600'];

      if (viewMode === 'hoje') {
        btnHoje.classList.add(...activeCls);
        btnHoje.classList.remove(...inactiveCls);
        btnMes.classList.remove(...activeCls);
        btnMes.classList.add(...inactiveCls);
      } else {
        btnMes.classList.add(...activeCls);
        btnMes.classList.remove(...inactiveCls);
        btnHoje.classList.remove(...activeCls);
        btnHoje.classList.add(...inactiveCls);
      }

      // Reset sort/pagination
      sortKey = null;
      sortAsc = true;
      currentPage = 1;

      createHeader();
      renderTable();
    }

    function bindModeToggle() {
      const btnHoje = document.getElementById('btnModeHoje');
      const btnMes = document.getElementById('btnModeMes');
      const btnOnly = document.getElementById('btnOnlyErrors');
      if (!btnHoje || !btnMes) return;

      btnHoje.addEventListener('click', () => setMode('hoje'));
      btnMes.addEventListener('click', () => setMode('mes'));

      if (btnOnly) {
        btnOnly.addEventListener('click', () => {
          onlyErrors = !onlyErrors;
          // estilo
          if (onlyErrors) {
            btnOnly.classList.add('bg-rose-50', 'text-rose-700', 'border-rose-200');
            btnOnly.classList.remove('bg-white', 'text-slate-700', 'border-slate-200');
          } else {
            btnOnly.classList.remove('bg-rose-50', 'text-rose-700', 'border-rose-200');
            btnOnly.classList.add('bg-white', 'text-slate-700', 'border-slate-200');
          }
          applyFilter();
        });
      }
    }

    async function loadData() {
      refreshIndicator.classList.remove('opacity-0');
      const r = await fetch(endpoint);
      originalData = await r.json();
      filteredData = [...originalData];
      if (!modeBound) { bindModeToggle(); modeBound = true; }
      // Garante que o layout principal abre em HOJE
      setMode(viewMode);
      setTimeout(() => refreshIndicator.classList.add('opacity-0'), 800);
    }

    loadData();
    setInterval(loadData, 300000);
  </script>

  <!-- MENU -->
  <script>
    (function () {
      const btn = document.getElementById('menuBtn');
      const panel = document.getElementById('menuPanel');

      if (!btn || !panel) return;

      const openMenu = () => {
        panel.classList.remove('hidden');
        btn.setAttribute('aria-expanded', 'true');
      };

      const closeMenu = () => {
        panel.classList.add('hidden');
        btn.setAttribute('aria-expanded', 'false');
      };

      const toggleMenu = () => {
        const isOpen = !panel.classList.contains('hidden');
        isOpen ? closeMenu() : openMenu();
      };

      btn.addEventListener('click', (e) => {
        e.stopPropagation();
        toggleMenu();
      });

      // Fecha clicando fora
      document.addEventListener('click', (e) => {
        if (!panel.contains(e.target) && e.target !== btn) closeMenu();
      });

      // Fecha no ESC
      document.addEventListener('keydown', (e) => {
        if (e.key === 'Escape') closeMenu();
      });

      // Accordion
      const getPanel = (key) => panel.querySelector(`[data-acc-panel="${key}"]`);
      const getBtn = (key) => panel.querySelector(`[data-acc-btn="${key}"]`);

      panel.querySelectorAll('[data-acc-btn]').forEach((accBtn) => {
        accBtn.addEventListener('click', (e) => {
          e.stopPropagation();

          const key = accBtn.getAttribute('data-acc-btn');
          const accPanel = getPanel(key);
          if (!accPanel) return;

          // Toggle do prÃ³prio painel
          accPanel.classList.toggle('hidden');

          // (Opcional) se fechar DFe, fecha filhos tambÃ©m
          if (key === 'dfe' && accPanel.classList.contains('hidden')) {
            const nfePanel = getPanel('nfe');
            const nfsePanel = getPanel('nfse');
            if (nfePanel) nfePanel.classList.add('hidden');
            if (nfsePanel) nfsePanel.classList.add('hidden');
          }
        });
      });

    })();
  </script>

  <!-- TROCA DE PÃGINA -->
  <a href="controle_nfe_logs.html" title="Logs e Erros" class="fixed bottom-6 right-6 z-50
       bg-slate-900 text-white
       p-4 rounded-full shadow-xl
       hover:bg-slate-800 transition">

    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"
      stroke-width="2">
      <path stroke-linecap="round" stroke-linejoin="round" d="M9 17v-2a4 4 0 014-4h2M7 7h10M7 11h10M7 15h4" />
    </svg>
  </a>

</body>

</html>