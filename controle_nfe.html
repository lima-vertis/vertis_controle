<!DOCTYPE html>
<html lang="pt-BR">

<head>
  <meta charset="UTF-8" />
  <title>NFC-e | Controle</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- Favicons e Icones -->
  <link rel="apple-touch-icon" href="https://v1.laudosonline.com.br/assets/images/apple-touch-icon.png" sizes="180x180">
  <link rel="icon" type="image/png" href="https://v1.laudosonline.com.br/assets/images/favicon.png" sizes="32x32">

  <style>
    .fade-in {
      animation: fadeInUp 0.25s ease-out;
    }

    @keyframes fadeInUp {
      from {
        opacity: 0;
        transform: translateY(4px);
      }

      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    .count {
      transition: all .3s ease;
    }
  </style>
</head>

<body class="bg-gradient-to-br from-slate-100 to-slate-200 min-h-screen flex flex-col">

  <!-- HEADER -->
  <header
    class="sticky top-0 z-50 backdrop-blur bg-slate-900/90 text-white px-6 py-4 flex justify-between items-center shadow">

    <!-- ESQUERDA -->
    <div class="flex items-center gap-4">

      <!-- MENU SANDU√çCHE -->
      <nav class="relative">
        <button id="menuBtn" class="p-2 rounded-lg hover:bg-slate-800 transition" aria-label="Abrir menu"
          aria-expanded="false" aria-controls="menuPanel">

          <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-white" fill="none" viewBox="0 0 24 24"
            stroke="currentColor" stroke-width="2">
            <path stroke-linecap="round" stroke-linejoin="round" d="M4 6h16M4 12h16M4 18h16" />
          </svg>
        </button>

        <!-- PAINEL -->
        <div id="menuPanel" class="absolute left-0 mt-3 w-72 rounded-xl bg-white text-slate-800 shadow-xl
           hidden overflow-hidden">

          <!-- HEADER DO PAINEL (opcional) -->
          <div class="px-4 py-3 border-b bg-slate-50">
            <div class="text-xs uppercase tracking-wide text-slate-500">Navega√ß√£o</div>
          </div>

          <div class="py-2 text-sm">

            <!-- DFe (n√≠vel 1) -->
            <button type="button"
              class="w-full flex items-center justify-between px-4 py-2 hover:bg-slate-100 font-semibold"
              data-acc-btn="dfe">
              <span>DFe (Documentos Fiscais)</span>
              <span class="text-slate-400">‚Ä∫</span>
            </button>

            <!-- Conte√∫do DFe (n√≠vel 2) -->
            <div class="hidden" data-acc-panel="dfe">

              <!-- NFe -->
              <button type="button"
                class="w-full flex items-center justify-between pl-8 pr-4 py-2 hover:bg-slate-100 text-slate-700 font-medium"
                data-acc-btn="nfe">
                <span>NFe</span>
                <span class="text-slate-400">‚Ä∫</span>
              </button>

              <div class="hidden" data-acc-panel="nfe">
                <a href="controle_nfe.html" class="block pl-12 pr-4 py-2 hover:bg-slate-100">
                  Vis√£o Geral
                </a>
                <a href="controle_nfe_logs.html" class="block pl-12 pr-4 py-2 hover:bg-slate-100">
                  Erros
                </a>
              </div>

              <!-- NFSe -->
              <button type="button"
                class="w-full flex items-center justify-between pl-8 pr-4 py-2 hover:bg-slate-100 text-slate-700 font-medium"
                data-acc-btn="nfse">
                <span>NFSe</span>
                <span class="text-slate-400">‚Ä∫</span>
              </button>

              <div class="hidden" data-acc-panel="nfse">
                <a href="nfse_visao_geral.html" class="block pl-12 pr-4 py-2 hover:bg-slate-100">
                  Vis√£o Geral
                </a>
                <a href="nfse_erros.html" class="block pl-12 pr-4 py-2 hover:bg-slate-100">
                  Erros
                </a>
              </div>

            </div>

            <!-- DESENVOLVIMENTO (n√≠vel 1) -->
            <button type="button"
              class="w-full flex items-center justify-between px-4 py-2 hover:bg-slate-100 font-semibold"
              data-acc-btn="dev">
              <span>Desenvolvimento</span>
              <span class="text-slate-400">‚Ä∫</span>
            </button>

            <!-- Conte√∫do Desenvolvimento (n√≠vel 2) -->
            <div class="hidden" data-acc-panel="dev">
              <a href="gerador_pix.html" class="block pl-8 pr-4 py-2 hover:bg-slate-100 text-slate-700">
                Chave PIX
              </a>
              <a href="leitor_pdf.html" class="block pl-8 pr-4 py-2 hover:bg-slate-100 text-slate-700">
                Leitor PDF (PDF.js)
              </a>
            </div>

          </div>
        </div>
      </nav>


      <!-- TEXTO -->
      <h1 class="text-lg font-semibold tracking-wide whitespace-nowrap">
        Vertis ‚Ä¢ NFe ‚Ä¢ Vis√£o Geral
      </h1>
    </div>

    <!-- DIREITA -->
    <div class="flex items-center gap-4">
      <span id="refreshIndicator" class="text-xs text-slate-300 opacity-0 transition-opacity">
        Atualizando...
      </span>

      <img src="https://v1.laudosonline.com.br/assets/images/logo-primary-white.png" alt="Vertis" class="h-8" />
    </div>

  </header>



  <main class="p-6 flex-1 space-y-6">

    <!-- KPIs -->
    <section class="grid grid-cols-1 xl:grid-cols-2 gap-4">

      <!-- HOJE -->
      <div class="bg-white rounded-2xl shadow p-4">
        <h2 class="text-sm font-semibold text-slate-600 mb-3">Hoje</h2>
        <div class="grid grid-cols-4 gap-3">
          <div>
            <p class="text-[11px] text-slate-500">Emit.</p>
            <p id="kpi_emit_hoje" class="text-xl font-bold count text-slate-700">0</p>
          </div>
          <div class="space-y-1"> <!-- Convertido -->
            <div class="flex items-center justify-between">
              <p class="text-[11px] text-slate-500">Conv.</p>
              <span id="kpi_conv_hoje_pct"
                class="text-[10px] px-1.5 py-0.5 rounded-full bg-emerald-50 text-emerald-700 font-medium">
                0%
              </span>
            </div>
            <p id="kpi_conv_hoje" class="text-2xl font-semibold text-emerald-600 count">0</p>
            <div class="h-1.5 bg-slate-200 rounded-full overflow-hidden">
              <div id="kpi_conv_hoje_bar" class="h-full bg-emerald-500 w-0 transition-all duration-300"></div>
            </div>
          </div>
          <div class="space-y-1"> <!-- Pendente Hoje -->
            <div class="flex items-center justify-between">
              <p class="text-[11px] text-slate-500">Pendentes</p>
              <span id="kpi_pend_hoje_pct"
                class="text-[10px] px-1.5 py-0.5 rounded-full bg-rose-50 text-rose-700 font-medium">
                0%
              </span>
            </div>
            <p id="kpi_pend_hoje" class="text-2xl font-semibold text-rose-600 count">0</p>
            <div class="h-1.5 bg-slate-200 rounded-full overflow-hidden">
              <div id="kpi_pend_hoje_bar" class="h-full bg-rose-500 w-0 transition-all duration-300"></div>
            </div>
          </div>
          <div class="space-y-1"> <!-- Cancelado Hoje -->
            <div class="flex items-center justify-between">
              <p class="text-[11px] text-slate-500">Cancelados</p>
              <span id="kpi_canc_hoje_pct"
                class="text-[10px] px-1.5 py-0.5 rounded-full bg-amber-50 text-amber-700 font-medium">
                0%
              </span>
            </div>
            <p id="kpi_canc_hoje" class="text-2xl font-semibold text-amber-600 count">0</p>
            <div class="h-1.5 bg-slate-200 rounded-full overflow-hidden">
              <div id="kpi_canc_hoje_bar" class="h-full bg-amber-500 w-0 transition-all duration-300"></div>
            </div>
          </div>
        </div>
      </div>

      <!-- M√äS -->
      <div class="bg-white rounded-2xl shadow p-4">
        <h2 class="text-sm font-semibold text-slate-600 mb-3">M√™s</h2>
        <div class="grid grid-cols-4 gap-3">
          <div>
            <p class="text-[11px] text-slate-500">Emit.</p>
            <p id="kpi_emit_mes" class="text-xl font-bold count text-slate-700">0</p>
          </div>
          <div class="space-y-1"> <!-- Convertido M√™s-->
            <div class="flex items-center justify-between">
              <p class="text-[11px] text-slate-500">Conv.</p>
              <span id="kpi_conv_mes_pct"
                class="text-[10px] px-1.5 py-0.5 rounded-full bg-emerald-50 text-emerald-700 font-medium">
                0%
              </span>
            </div>
            <p id="kpi_conv_mes" class="text-2xl font-semibold text-emerald-600 count">0</p>
            <div class="h-1.5 bg-slate-200 rounded-full overflow-hidden">
              <div id="kpi_conv_mes_bar" class="h-full bg-emerald-500 w-0 transition-all duration-300"></div>
            </div>
          </div>
          <div class="space-y-1"> <!-- Pendente M√™s -->
            <div class="flex items-center justify-between">
              <p class="text-[11px] text-slate-500">Pendentes</p>
              <span id="kpi_pend_mes_pct"
                class="text-[10px] px-1.5 py-0.5 rounded-full bg-rose-50 text-rose-700 font-medium">
                0%
              </span>
            </div>
            <p id="kpi_pend_mes" class="text-2xl font-semibold text-rose-600 count">0</p>
            <div class="h-1.5 bg-slate-200 rounded-full overflow-hidden">
              <div id="kpi_pend_mes_bar" class="h-full bg-rose-500 w-0 transition-all duration-300"></div>
            </div>
          </div>
          <div class="space-y-1"> <!-- Cancelado M√™s -->
            <div class="flex items-center justify-between">
              <p class="text-[11px] text-slate-500">Cancelados</p>
              <span id="kpi_canc_mes_pct"
                class="text-[10px] px-1.5 py-0.5 rounded-full bg-amber-50 text-amber-700 font-medium">
                0%
              </span>
            </div>
            <p id="kpi_canc_mes" class="text-2xl font-semibold text-amber-600 count">0</p>
            <div class="h-1.5 bg-slate-200 rounded-full overflow-hidden">
              <div id="kpi_canc_mes_bar" class="h-full bg-amber-500 w-0 transition-all duration-300"></div>
            </div>
          </div>
        </div>
      </div>

    </section>

    <!-- FILTRO -->
    <div class="bg-white rounded-2xl shadow p-4 flex items-center gap-4">
      <input id="filterInput" type="text" placeholder="üîç Filtrar por c√≥digo ou nome da unidade..."
        class="w-full border rounded-xl px-4 py-2 focus:outline-none focus:ring" oninput="applyFilter()" />
      <span class="text-sm text-slate-500 whitespace-nowrap">Auto-refresh 5 min</span>
    </div>

    <!-- TABELA -->
    <div class="bg-white rounded-2xl shadow overflow-x-auto max-h-[70vh]">
      <table class="min-w-full text-sm border-collapse">
        <thead class="bg-slate-200 sticky top-0 z-40">
          <tr id="table-head"></tr>
        </thead>
        <tbody id="table-body" class="divide-y"></tbody>
        <tfoot class="bg-slate-100 sticky bottom-0 font-semibold">
          <tr id="table-footer"></tr>
        </tfoot>
      </table>
    </div>

    <!-- PAGINA√á√ÉO -->
    <div class="flex items-center justify-between px-2 text-sm text-slate-600">
      <span id="pageInfo"></span>
      <div id="pagination" class="flex gap-1"></div>
    </div>

  </main>

  <script>
    // const endpoint = "http://177.11.209.38/vertis/VertisConnect.dll/api/V1.1/get_nfce_controle";
    const endpoint = "/api/nfce/controle";

    const PAGE_SIZE = 10;
    let currentPage = 1;

    const columns = [
      { key: 'cod_unid_negoc', label: 'Neg', sticky: true, width: 50 },
      { key: 'cod_unid_oper', label: 'Oper', sticky: true, width: 50 },
      { key: 'nom_unid_oper', label: 'Cliente', sticky: true, width: 250 },

      { key: 'dth_ult_emissao', label: '√ölt. Emiss√£o' },
      { key: 'dth_ult_conversao', label: '√ölt. Convers√£o' },

      { key: 'qtd_emit_hoje', label: 'Emit. Hoje', sum: true },
      { key: 'qtd_conv_hoje', label: 'Conv. Hoje', sum: true },
      { key: 'qtd_pend_hoje', label: 'Pend. Hoje', sum: true },
      { key: 'qtd_canc_hoje', label: 'Canc. Hoje', sum: true },

      { key: 'qtd_emit_mes', label: 'Emit. M√™s', sum: true },
      { key: 'qtd_conv_mes', label: 'Conv. M√™s', sum: true },
      { key: 'qtd_pend_mes', label: 'Pend. M√™s', sum: true },
      { key: 'qtd_canc_mes', label: 'Canc. M√™s', sum: true },

      { key: 'dth_ult_atualizacao', label: 'Atualiza√ß√£o' }
    ];

    let originalData = [], filteredData = [], sortKey = null, sortAsc = true;

    const getPagedData = () =>
      filteredData.slice((currentPage - 1) * PAGE_SIZE, currentPage * PAGE_SIZE);

    const totalPages = () =>
      Math.ceil(filteredData.length / PAGE_SIZE) || 1;

    /* ===== KPIs ===== */
    const pct = (valor, total) =>
      total > 0 ? ((valor / total) * 100).toFixed(1) + '%' : '0%';

    const setBar = (id, valor, total) => {
      const el = document.getElementById(id);
      if (!el) return;

      const pct = total > 0 ? Math.min((valor / total) * 100, 100) : 0;
      el.style.width = pct + '%';
    };

    function updateKPIs() {
      const sum = k => filteredData.reduce((t, r) => t + Number(r[k] || 0), 0);

      const map = {
        kpi_emit_hoje: sum('qtd_emit_hoje'),
        kpi_conv_hoje: sum('qtd_conv_hoje'),
        kpi_pend_hoje: sum('qtd_pend_hoje'),
        kpi_canc_hoje: sum('qtd_canc_hoje'),
        kpi_emit_mes: sum('qtd_emit_mes'),
        kpi_conv_mes: sum('qtd_conv_mes'),
        kpi_pend_mes: sum('qtd_pend_mes'),
        kpi_canc_mes: sum('qtd_canc_mes')
      };

      Object.entries(map).forEach(([id, val]) => {
        const el = document.getElementById(id);
        el.textContent = val;
        el.classList.toggle('text-red-600', id.includes('pend') && val > 0);
      });

      // Percentuais - base Emitidos
      document.getElementById('kpi_conv_hoje_pct').textContent =
        pct(sum('qtd_conv_hoje'), sum('qtd_emit_hoje'));

      document.getElementById('kpi_pend_hoje_pct').textContent =
        pct(sum('qtd_pend_hoje'), sum('qtd_emit_hoje'));

      document.getElementById('kpi_canc_hoje_pct').textContent =
        pct(sum('qtd_canc_hoje'), sum('qtd_emit_hoje'));

      document.getElementById('kpi_conv_mes_pct').textContent =
        pct(sum('qtd_conv_mes'), sum('qtd_emit_mes'));

      document.getElementById('kpi_pend_mes_pct').textContent =
        pct(sum('qtd_pend_mes'), sum('qtd_emit_mes'));

      document.getElementById('kpi_canc_mes_pct').textContent =
        pct(sum('qtd_canc_mes'), sum('qtd_emit_mes'));

      // Barras - Hoje
      setBar('kpi_conv_hoje_bar', sum('qtd_conv_hoje'), sum('qtd_emit_hoje'));
      setBar('kpi_pend_hoje_bar', sum('qtd_pend_hoje'), sum('qtd_emit_hoje'));
      setBar('kpi_canc_hoje_bar', sum('qtd_canc_hoje'), sum('qtd_emit_hoje'));

      // Barras - M√™s
      setBar('kpi_conv_mes_bar', sum('qtd_conv_mes'), sum('qtd_emit_mes'));
      setBar('kpi_pend_mes_bar', sum('qtd_pend_mes'), sum('qtd_emit_mes'));
      setBar('kpi_canc_mes_bar', sum('qtd_canc_mes'), sum('qtd_emit_mes'));

    }

    /* ===== TABLE ===== */
    function createHeader() {
      const tr = document.getElementById('table-head');
      tr.innerHTML = '';
      let left = 0;

      columns.forEach(col => {
        const th = document.createElement('th');
        let cls = 'px-3 py-2 whitespace-nowrap cursor-pointer';
        if (col.key.startsWith('qtd_')) cls += ' text-center';

        if (col.sticky) {
          cls += ' sticky bg-slate-200 z-50';
          th.style.left = left + 'px';
          th.style.width = col.width + 'px';
          left += col.width;
        }

        th.className = cls;
        th.textContent = col.label;
        th.onclick = () => sortBy(col.key);
        tr.appendChild(th);
      });
    }

    function renderTable() {
      const tbody = document.getElementById('table-body');
      tbody.innerHTML = '';

      getPagedData().forEach((row, i) => {
        const tr = document.createElement('tr');
        tr.className = `${i % 2 ? 'bg-slate-50' : 'bg-white'} hover:bg-slate-100 fade-in`;
        let left = 0;

        columns.forEach(col => {
          const td = document.createElement('td');
          let cls = 'px-3 py-2 whitespace-nowrap';

          if (col.key.startsWith('qtd_')) cls += ' text-center font-medium';

          if (col.sticky) {
            cls += ' sticky z-40 ' + (i % 2 ? 'bg-slate-50' : 'bg-white');
            td.style.left = left + 'px';
            td.style.width = col.width + 'px';
            left += col.width;
          }

          td.className = cls;
          td.textContent = row[col.key] ?? '';
          tr.appendChild(td);
        });
        tbody.appendChild(tr);
      });

      renderFooter();
      updateKPIs();
      renderPagination();
    }

    function renderFooter() {
      const tr = document.getElementById('table-footer');
      tr.innerHTML = '';
      let left = 0;

      columns.forEach((col, i) => {
        const td = document.createElement('td');
        let cls = 'px-3 py-2';
        if (col.key.startsWith('qtd_')) cls += ' text-center';

        if (col.sticky) {
          cls += ' sticky bg-slate-100 z-40';
          td.style.left = left + 'px';
          td.style.width = col.width + 'px';
          left += col.width;
        }

        td.className = cls;
        td.textContent = i === 0
          ? 'Totais'
          : col.sum
            ? filteredData.reduce((t, r) => t + Number(r[col.key] || 0), 0)
            : '';
        tr.appendChild(td);
      });
    }

    function renderPagination() {
      const total = totalPages();
      const delta = 1; // quantas p√°ginas antes/depois da atual
      const pages = [];
      const range = [];

      pageInfo.textContent =
        `P√°gina ${currentPage} de ${total} ‚Ä¢ ${filteredData.length} registros`;

      // Sempre inclui primeira e √∫ltima
      range.push(1);
      if (total > 1) range.push(total);

      // P√°ginas ao redor da atual
      for (let i = currentPage - delta; i <= currentPage + delta; i++) {
        if (i > 1 && i < total) range.push(i);
      }

      // Ordena e remove duplicados
      [...new Set(range)].sort((a, b) => a - b).forEach(p => pages.push(p));

      pagination.innerHTML = '';

      let last = 0;
      pages.forEach(p => {
        if (p - last > 1) {
          const dots = document.createElement('span');
          dots.textContent = '‚Ä¶';
          dots.className = 'px-2 text-slate-400';
          pagination.appendChild(dots);
        }

        const btn = document.createElement('button');
        btn.textContent = p;
        btn.className =
          `px-2 py-1 rounded ${p === currentPage
            ? 'bg-slate-700 text-white'
            : 'bg-slate-200 hover:bg-slate-300'
          }`;

        btn.onclick = () => {
          currentPage = p;
          renderTable();
        };

        pagination.appendChild(btn);
        last = p;
      });
    }


    function sortBy(key) {
      sortAsc = sortKey === key ? !sortAsc : true;
      sortKey = key;
      currentPage = 1;

      filteredData.sort((a, b) => {
        const n1 = Number(a[key]), n2 = Number(b[key]);
        if (!isNaN(n1) && !isNaN(n2)) return sortAsc ? n1 - n2 : n2 - n1;
        return sortAsc
          ? String(a[key]).localeCompare(String(b[key]))
          : String(b[key]).localeCompare(String(a[key]));
      });

      renderTable();
    }

    function applyFilter() {
      const v = filterInput.value.toLowerCase();
      filteredData = originalData.filter(r =>
        String(r.cod_unid_negoc).includes(v) ||
        String(r.cod_unid_oper).includes(v) ||
        String(r.nom_unid_oper).toLowerCase().includes(v)
      );
      currentPage = 1;
      renderTable();
    }

    async function loadData() {
      refreshIndicator.classList.remove('opacity-0');
      const r = await fetch(endpoint);
      originalData = await r.json();
      filteredData = [...originalData];
      createHeader();
      renderTable();
      setTimeout(() => refreshIndicator.classList.add('opacity-0'), 800);
    }

    loadData();
    setInterval(loadData, 300000);
  </script>

  <!-- MENU -->
  <script>
    (function () {
      const btn = document.getElementById('menuBtn');
      const panel = document.getElementById('menuPanel');

      if (!btn || !panel) return;

      const openMenu = () => {
        panel.classList.remove('hidden');
        btn.setAttribute('aria-expanded', 'true');
      };

      const closeMenu = () => {
        panel.classList.add('hidden');
        btn.setAttribute('aria-expanded', 'false');
      };

      const toggleMenu = () => {
        const isOpen = !panel.classList.contains('hidden');
        isOpen ? closeMenu() : openMenu();
      };

      btn.addEventListener('click', (e) => {
        e.stopPropagation();
        toggleMenu();
      });

      // Fecha clicando fora
      document.addEventListener('click', (e) => {
        if (!panel.contains(e.target) && e.target !== btn) closeMenu();
      });

      // Fecha no ESC
      document.addEventListener('keydown', (e) => {
        if (e.key === 'Escape') closeMenu();
      });

      // Accordion
      const getPanel = (key) => panel.querySelector(`[data-acc-panel="${key}"]`);
      const getBtn = (key) => panel.querySelector(`[data-acc-btn="${key}"]`);

      panel.querySelectorAll('[data-acc-btn]').forEach((accBtn) => {
        accBtn.addEventListener('click', (e) => {
          e.stopPropagation();

          const key = accBtn.getAttribute('data-acc-btn');
          const accPanel = getPanel(key);
          if (!accPanel) return;

          // Toggle do pr√≥prio painel
          accPanel.classList.toggle('hidden');

          // (Opcional) se fechar DFe, fecha filhos tamb√©m
          if (key === 'dfe' && accPanel.classList.contains('hidden')) {
            const nfePanel = getPanel('nfe');
            const nfsePanel = getPanel('nfse');
            if (nfePanel) nfePanel.classList.add('hidden');
            if (nfsePanel) nfsePanel.classList.add('hidden');
          }
        });
      });

    })();
  </script>

  <!-- TROCA DE P√ÅGINA -->
  <a href="controle_nfe_logs.html" title="Logs e Erros" class="fixed bottom-6 right-6 z-50
       bg-slate-900 text-white
       p-4 rounded-full shadow-xl
       hover:bg-slate-800 transition">

    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"
      stroke-width="2">
      <path stroke-linecap="round" stroke-linejoin="round" d="M9 17v-2a4 4 0 014-4h2M7 7h10M7 11h10M7 15h4" />
    </svg>
  </a>

</body>

</html>